@startuml ConsulterMajDossier
title Consulter et mettre à jour le dossier 

actor "Professionnel de santé" as ProfSante
participant "ProfessionelUI" as UI
participant "PatientService" as PatientService
participant "ConsultationService" as ConsService
participant "Patient" as PatientObj
participant "DossierMedical" as Dossier
participant "ProfessionnelSante" as ProfObj
participant "DataService" as DataService

== Consultation du dossier ==
ProfSante -> UI : Consulter dossier patient
activate UI

UI --> ProfSante : Demande idPatient
ProfSante -> UI : Saisir idPatient

UI -> PatientService : findPatientById(idPatient)
activate PatientService
PatientService --> UI : patient ou null
deactivate PatientService

alt Patient trouvé
    UI -> PatientObj : getDossierMedical()
    activate PatientObj
    PatientObj --> UI : dossierMedical
    deactivate PatientObj

    UI -> Dossier : getAntecedents(), getConsultations()
    activate Dossier
    Dossier --> UI : listes antécédents et consultations
    deactivate Dossier

    ' Filtre par spécialité du professionnel connecté
    UI -> ProfObj : getSpecialite()
    activate ProfObj
    ProfObj --> UI : specialiteCourante
    deactivate ProfObj

    UI --> ProfSante : Affichage dossier\n+ consultations de specialiteCourante

    == Ajout d'un antécédent ==
    ProfSante -> UI : Choisir "Ajouter antécédent"

    ' Vérification permission via accessLevels (chiffre 5)
    UI -> ProfObj : getAccessLevels()
    activate ProfObj
    ProfObj --> UI : accessLevels
    deactivate ProfObj

    alt accessLevels contient '5'
        UI --> ProfSante : Saisie type/description/date/gravité/statut
        ProfSante -> UI : Valider

        UI -> PatientService : ajouterAntecedentAuPatient(idPatient, antecedent)
        activate PatientService
        PatientService --> UI : success / échec
        deactivate PatientService

        alt success
            UI -> DataService : saveAntecedents(patients)
            activate DataService
            DataService --> UI : sauvegardé
            deactivate DataService

            UI --> ProfSante : ✓ Antécédent ajouté
        else échec
            UI --> ProfSante : ❌ Erreur d'ajout
        end
    else pas de permission
        UI --> ProfSante : ❌ Accès refusé (permission manquante)
    end

else Patient introuvable
    UI --> ProfSante : ❌ Patient non trouvé
end

deactivate UI

note right of UI
  Permissions = chaîne accessLevels :
  1: patients, 2: programmation,
  3: planning, 4: clôture, 5: antécédents.
end note

@enduml
